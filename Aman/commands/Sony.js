const axios = require("axios");

module.exports.config = {
  name: "sony",
  version: "1.0.2",
  hasPermssion: 0,
  credits: "Aman",
  description: "Gemini chatbot with sony/bot trigger and reply context",
  commandCategory: "no prefix",
  usages: "no prefix",
  cooldowns: 2
};

module.exports.handleEvent = async function ({ api, event }) {
  const { threadID, messageID, body, senderID, messageReply } = event;

  if (!body || senderID == api.getCurrentUserID()) return;

  const lowerBody = body.toLowerCase();

  // Trigger words check
  const hasTriggerWords = lowerBody.includes("sony") || lowerBody.includes("SONY");

  // Check: reply to bot + message actually generated by sony command
  const isReplyToSonyBot =
    messageReply &&
    messageReply.senderID == api.getCurrentUserID() &&
    messageReply.body &&
    messageReply.body.includes("â˜…á­„ğğ°ğ§ğğ« ğ€ ğŠ"); // unique tag Sony msg ka

  if (hasTriggerWords || isReplyToSonyBot) {
    try {
      // Reaction ğŸ¥°
      api.setMessageReaction("ğŸ¥°", messageID, (err) => {}, true);

      // Sender name fetch
      const userInfo = await api.getUserInfo(senderID);
      const userName = userInfo[senderID]?.name || "User";

      let finalMessage = body;

      // If replying to Sony bot's message, include context
      if (isReplyToSonyBot && messageReply) {
        const repliedMessage = messageReply.body || "";
        finalMessage = `Previous message: ${repliedMessage} | User's reply: ${body}`;
      }

      // API call with context
      const res = await axios.post("https://api-h92t.onrender.com/gemini", {
        message: finalMessage
      });

      if (!res.data || !res.data.reply) {
        return api.sendMessage("âš ï¸ sony ne sahi reply nahi diya.", threadID, messageID);
      }

      // Final message format with decorative headers
      const finalMsg = `
âœ¨ ${userName} âœ¨
âœ¿â”â”â”â”â”â”â”â”âŠ±ğŸŒºâŠ°â”â”â”â”â”â”â”â”âœ¿

${res.data.reply}
âœ¿â”â”â”â”â”â”â”â”âŠ±ğŸŒºâŠ°â”â”â”â”â”â”â”â”âœ¿
*â˜…á­„ğğ°ğ§ğğ« ğ€ ğŠ âš”ï¸â¤ÍŸÍŸÍÍâ˜…*
`;

      return api.sendMessage(finalMsg, threadID, messageID);
    } catch (error) {
      console.error("Gemini API error:", error.message);

      // Multiple funny/romantic error messages
      const errorMessages = [
        "Tum online ho aur reply nahi dete, dil todna bhi ek art hai kya ğŸ˜",
        "Mujhe tumse ek complaint hai... tum cute itne kyu ho ğŸ¥ºğŸ’–",
        "Suno ji, tumhari yaad aati hai jaise mobile ko charging ki zarurat hoti hai âš¡â¤ï¸",
        "Aaj mausam bada suhana hai, tum mil jao to aur bhi deewana hai ğŸŒ¸",
        "Khud pe itna na karo tum ghamand, tumhe dekh ke to dil ka signal ho gaya jammed ğŸ˜œ",
        "Life me tension mat lo, warna tumhare dimples bhi chhup jayenge ğŸ˜‰",
        "Pizza aur tum dono favourite ho, farq bas itna hai pizza khane ko mil jata hai ğŸ•â¤ï¸",
        "Dil garden-garden ho jata hai jab tum online aate ho ğŸŒ¹",
        "Tumhari smile meri weakness hai, please jyada mat hansa karo â˜ºï¸",
        "Abhi to zindagi me bahut goals hai, par sabse bada goal tum ho ğŸ˜˜",
        "Tera naam WhatsApp pe aata hai to lagta hai life mast chal rahi hai ğŸ¤©",
        "Tumhare bina ye duniya adhoori si lagti hai, jaise chai bina biscuit ğŸ˜†â˜•",
        "Tum smart ho ya main hi tumhe dekh ke pagal ho gayi hoon ğŸ¤­",
        "Tum meri life ka wo chapter ho jisme sirf smile hi smile likha hai ğŸ˜",
        "Chhodo na ye duniya walo ki baatein, aao hum dono ek chhoti si duniya bana le ğŸ’•",
        "Sad mat ho yaar, warna tumhari ankho ki chamak kam ho jayegi ğŸŒŸ",
        "Tumhari baaton me wo magic hai, jo har boring din ko special bana deta hai âœ¨",
        "Dil chahta hai tumhe bas roz pareshaan karu aur tum hamesha hans ke reply do ğŸ˜‹",
        "Tum meri coffee ho yaad aati ho subah-subah aur din acha kar deti ho â˜•â¤ï¸",
        "Mujhe tumse ek problem haiâ€¦ tumhe bhool hi nahi paati ğŸ˜"
      ];

      const randomMsg = errorMessages[Math.floor(Math.random() * errorMessages.length)];

      return api.sendMessage(randomMsg, threadID, messageID);
    }
  }
};

module.exports.run = async function () {
  return;
};
